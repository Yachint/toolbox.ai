<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Claude Weekly Usage Planner</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Plan your Claude AI usage to last the entire week with smart budgeting">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Claude Planner">
    <meta name="application-name" content="Claude Planner">
    <meta name="msapplication-TileColor" content="#1a1a2e">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü§ñ</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%231a1a2e' width='100' height='100' rx='20'/><text y='.9em' x='50' text-anchor='middle' font-size='70'>ü§ñ</text></svg>">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e8e8e8;
            padding: 20px;
            padding-top: calc(20px + env(safe-area-inset-top));
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            position: relative;
            overflow-x: hidden;
        }

        /* Claude logo rain background */
        .bg-pattern {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;
            pointer-events: none;
            overflow: hidden;
        }

        .bg-pattern svg {
            position: absolute;
            opacity: 0.04;
            fill: #ffffff;
            will-change: transform;
        }

        /* Snowfall animations - different speeds for variety */
        @keyframes snowfall1 {
            0% {
                transform: translateY(-100px) rotate(0deg);
            }
            100% {
                transform: translateY(calc(100vh + 100px)) rotate(360deg);
            }
        }

        @keyframes snowfall2 {
            0% {
                transform: translateY(-100px) rotate(0deg) translateX(0px);
            }
            50% {
                transform: translateY(50vh) rotate(180deg) translateX(20px);
            }
            100% {
                transform: translateY(calc(100vh + 100px)) rotate(360deg) translateX(0px);
            }
        }

        @keyframes snowfall3 {
            0% {
                transform: translateY(-100px) rotate(0deg) translateX(0px);
            }
            50% {
                transform: translateY(50vh) rotate(-180deg) translateX(-15px);
            }
            100% {
                transform: translateY(calc(100vh + 100px)) rotate(-360deg) translateX(0px);
            }
        }

        .snowflake {
            animation-timing-function: linear;
            animation-iteration-count: infinite;
        }

        .snow-speed-1 { animation-duration: 25s; }
        .snow-speed-2 { animation-duration: 30s; }
        .snow-speed-3 { animation-duration: 35s; }
        .snow-speed-4 { animation-duration: 40s; }
        .snow-speed-5 { animation-duration: 45s; }

        .snow-anim-1 { animation-name: snowfall1; }
        .snow-anim-2 { animation-name: snowfall2; }
        .snow-anim-3 { animation-name: snowfall3; }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2rem;
            background: linear-gradient(90deg, #64b5f6, #42a5f5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
            font-size: 0.95rem;
        }

        .input-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .input-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-end;
            justify-content: center;
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-size: 0.85rem;
            color: #aaa;
            font-weight: 500;
            text-align: left;
        }

        input, select {
            padding: 12px 16px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 1rem;
            min-width: 160px;
            height: 48px;
            box-sizing: border-box;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23ffffff' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        input[type="time"] {
            -webkit-appearance: none;
            appearance: none;
        }

        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            opacity: 0.7;
            cursor: pointer;
        }

        input[type="number"] {
            -moz-appearance: textfield;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #42a5f5;
            box-shadow: 0 0 0 3px rgba(66, 165, 245, 0.2);
        }

        button {
            padding: 12px 30px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, #42a5f5, #1e88e5);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66, 165, 245, 0.4);
        }

        .results-section {
            display: none;
        }

        .results-section.visible {
            display: block;
        }

        .recommendation-card {
            background: linear-gradient(135deg, rgba(66, 165, 245, 0.15), rgba(30, 136, 229, 0.1));
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(66, 165, 245, 0.3);
        }

        .recommendation-card h2 {
            font-size: 1.1rem;
            color: #64b5f6;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .recommendation-card h2::before {
            content: "üí°";
        }

        .main-recommendation {
            font-size: 2.5rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 10px;
        }

        .recommendation-detail {
            color: #aaa;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .stats-row {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .stat-badge {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .stat-badge span {
            color: #64b5f6;
            font-weight: 600;
        }

        .calendar-section h2 {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .calendar-section h2::before {
            content: "üìÖ";
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }

        .day-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        /* Background fill effect */
        .day-card::before {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--fill-percent, 0%);
            background: var(--fill-color, rgba(66, 165, 245, 0.15));
            transition: height 0.5s ease;
            z-index: -1;
        }

        .day-card:hover {
            transform: translateY(-3px);
            border-color: var(--border-color, rgba(66, 165, 245, 0.3));
        }

        /* Color coding based on percentage */
        .day-card.level-safe {
            --fill-color: rgba(76, 175, 80, 0.2);
            --border-color: rgba(76, 175, 80, 0.4);
        }
        .day-card.level-safe .day-percentage {
            color: #81c784;
        }

        .day-card.level-moderate {
            --fill-color: rgba(66, 165, 245, 0.2);
            --border-color: rgba(66, 165, 245, 0.4);
        }
        .day-card.level-moderate .day-percentage {
            color: #64b5f6;
        }

        .day-card.level-warning {
            --fill-color: rgba(255, 193, 7, 0.2);
            --border-color: rgba(255, 193, 7, 0.4);
        }
        .day-card.level-warning .day-percentage {
            color: #ffd54f;
        }

        .day-card.level-danger {
            --fill-color: rgba(244, 67, 54, 0.2);
            --border-color: rgba(244, 67, 54, 0.4);
        }
        .day-card.level-danger .day-percentage {
            color: #e57373;
        }

        .day-card.today {
            border-width: 2px;
            border-color: #42a5f5;
            box-shadow: 0 0 15px rgba(66, 165, 245, 0.3);
        }

        .day-card.past {
            opacity: 0.5;
        }

        .day-name {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .day-date {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: #e0e0e0;
        }

        .day-percentage {
            font-size: 1.8rem;
            font-weight: 700;
            color: #64b5f6;
            margin-bottom: 4px;
        }

        .day-label {
            font-size: 0.75rem;
            color: #666;
        }

        .day-card.today .day-label {
            color: #42a5f5;
            font-weight: 600;
        }

        .buffer-info {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .buffer-info::before {
            content: "üõ°Ô∏è";
            font-size: 1.5rem;
        }

        .buffer-info p {
            color: #81c784;
            font-size: 0.9rem;
        }

        .current-usage-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .current-usage-section label {
            display: block;
            margin-bottom: 8px;
        }

        .usage-input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .usage-input-row input {
            width: 100px;
        }

        .remaining-today {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 10px 16px;
            color: #ffd54f;
            font-weight: 500;
        }

        .by-midnight-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 12px;
            padding: 12px 16px;
            background: rgba(100, 181, 246, 0.1);
            border: 1px solid rgba(100, 181, 246, 0.3);
            border-radius: 8px;
        }

        .midnight-label {
            color: #90caf9;
            font-size: 0.9rem;
        }

        .midnight-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: #64b5f6;
        }

        .last-updated {
            text-align: center;
            color: #666;
            font-size: 0.8rem;
            margin-top: 20px;
            font-style: italic;
        }

        /* Additional Features Section */
        .additional-features {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .additional-features h2 {
            text-align: center;
            font-size: 1.3rem;
            color: #64b5f6;
            margin-bottom: 25px;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .feature-card h3 {
            font-size: 1.1rem;
            color: #fff;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .feature-card h3 .icon {
            font-size: 1.3rem;
        }

        .feature-input-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .feature-input-group label {
            color: #aaa;
            font-size: 0.9rem;
        }

        .feature-input-group input {
            width: 100px;
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 1rem;
        }

        .feature-input-group .unit {
            color: #888;
            font-size: 0.9rem;
        }

        /* Usage Tracking Styles */
        .tracking-results {
            display: none;
        }

        .tracking-results.visible {
            display: block;
        }

        .usage-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .comparison-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .comparison-item .label {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 5px;
        }

        .comparison-item .value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .comparison-item .value.planned {
            color: #64b5f6;
        }

        .comparison-item .value.actual {
            color: #ffd54f;
        }

        .status-indicator {
            padding: 15px 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .status-indicator .icon {
            font-size: 1.5rem;
        }

        .status-indicator .text {
            font-size: 0.95rem;
        }

        .status-indicator.ahead {
            background: rgba(76, 175, 80, 0.15);
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .status-indicator.ahead .text {
            color: #81c784;
        }

        .status-indicator.on-track {
            background: rgba(66, 165, 245, 0.15);
            border: 1px solid rgba(66, 165, 245, 0.3);
        }

        .status-indicator.on-track .text {
            color: #64b5f6;
        }

        .status-indicator.behind {
            background: rgba(255, 193, 7, 0.15);
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .status-indicator.behind .text {
            color: #ffd54f;
        }

        .status-indicator.over {
            background: rgba(244, 67, 54, 0.15);
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .status-indicator.over .text {
            color: #e57373;
        }

        .remaining-budget {
            font-size: 1.1rem;
            color: #e0e0e0;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .remaining-budget strong {
            color: #81c784;
        }

        /* Sleep Compensation */
        .sleep-compensation-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sleep-toggle-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 26px;
            transition: 0.3s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: #888;
            border-radius: 50%;
            transition: 0.3s;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: linear-gradient(135deg, #7c4dff, #536dfe);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
            background-color: white;
        }

        .sleep-toggle-label {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .sleep-toggle-title {
            font-size: 0.95rem;
            color: #e0e0e0;
            font-weight: 500;
        }

        .sleep-toggle-desc {
            font-size: 0.75rem;
            color: #888;
        }

        .sleep-inputs {
            display: none;
            background: rgba(124, 77, 255, 0.1);
            border: 1px solid rgba(124, 77, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
        }

        .sleep-inputs.show {
            display: block;
        }

        .sleep-input-row {
            display: flex;
            gap: 15px;
            margin-bottom: 12px;
        }

        .sleep-field {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .sleep-field label {
            font-size: 0.8rem;
            color: #aaa;
        }

        .sleep-field input {
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 0.95rem;
        }

        .sleep-info {
            font-size: 0.85rem;
            color: #b388ff;
            margin: 0;
        }

        .sleep-info strong {
            color: #e0e0e0;
        }

        /* Extended Usage Card */
        .extended-usage-card {
            display: none;
            background: linear-gradient(135deg, rgba(124, 77, 255, 0.15), rgba(83, 109, 254, 0.1));
            border: 1px solid rgba(124, 77, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .extended-usage-card.show {
            display: block;
        }

        .extended-usage-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .extended-icon {
            font-size: 1.3rem;
        }

        .extended-title {
            font-size: 0.9rem;
            color: #b388ff;
            font-weight: 500;
        }

        .extended-usage-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #b388ff;
            margin-bottom: 8px;
        }

        .extended-usage-breakdown {
            font-size: 0.85rem;
            color: #aaa;
            margin-bottom: 10px;
        }

        .extended-usage-breakdown strong {
            color: #e0e0e0;
        }

        .extended-usage-note {
            font-size: 0.8rem;
            color: #888;
            font-style: italic;
            margin: 0;
        }

        /* Cooldown Timer */
        .cooldown-timer {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.15), rgba(255, 152, 0, 0.1));
            border: 1px solid rgba(244, 67, 54, 0.3);
            border-radius: 12px;
            text-align: center;
        }

        .cooldown-timer.show {
            display: block;
        }

        .cooldown-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .cooldown-icon {
            font-size: 1.5rem;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .cooldown-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #ff8a65;
        }

        .cooldown-explanation {
            font-size: 0.85rem;
            color: #aaa;
            margin-bottom: 15px;
        }

        .cooldown-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
        }

        .countdown-unit {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            padding: 12px 16px;
            border-radius: 10px;
            min-width: 70px;
        }

        .countdown-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #ff8a65;
            font-variant-numeric: tabular-nums;
        }

        .countdown-label {
            font-size: 0.7rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .countdown-separator {
            font-size: 1.5rem;
            color: #ff8a65;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .cooldown-resume {
            font-size: 0.9rem;
            color: #bbb;
        }

        .cooldown-resume strong {
            color: #ff8a65;
        }

        /* Progress bar */
        .progress-container {
            margin: 20px 0;
        }

        .progress-bar-bg {
            height: 24px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar-planned {
            position: absolute;
            height: 100%;
            background: rgba(66, 165, 245, 0.4);
            border-radius: 12px;
            transition: width 0.3s ease;
        }

        .progress-bar-actual {
            position: absolute;
            height: 100%;
            background: linear-gradient(90deg, #81c784, #66bb6a);
            border-radius: 12px;
            transition: width 0.3s ease;
        }

        .progress-bar-actual.over-budget {
            background: linear-gradient(90deg, #ffd54f, #ff9800);
        }

        .progress-bar-actual.way-over {
            background: linear-gradient(90deg, #e57373, #f44336);
        }

        .progress-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.75rem;
            color: #888;
        }

        /* What-If Calculator Styles */
        .whatif-results {
            display: none;
        }

        .whatif-results.visible {
            display: block;
        }

        .whatif-impact {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .impact-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .impact-item .label {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 5px;
        }

        .impact-item .value {
            font-size: 1.3rem;
            font-weight: 700;
        }

        .impact-item .value.current {
            color: #64b5f6;
        }

        .impact-item .value.new {
            color: #ffd54f;
        }

        .impact-item .value.warning {
            color: #e57373;
        }

        .whatif-warning {
            background: rgba(244, 67, 54, 0.15);
            border: 1px solid rgba(244, 67, 54, 0.3);
            border-radius: 10px;
            padding: 15px;
            color: #e57373;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .whatif-ok {
            background: rgba(76, 175, 80, 0.15);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 10px;
            padding: 15px;
            color: #81c784;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .settings-saved-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .settings-saved-toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* PWA Install Banner */
        .pwa-install-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #1e3a5f, #1a1a2e);
            padding: 16px 20px;
            display: none;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            border-top: 1px solid rgba(66, 165, 245, 0.3);
            z-index: 1001;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        }

        .pwa-install-banner.show {
            display: flex;
        }

        .pwa-install-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .pwa-install-icon {
            font-size: 2rem;
        }

        .pwa-install-text h4 {
            font-size: 0.95rem;
            color: #fff;
            margin-bottom: 2px;
        }

        .pwa-install-text p {
            font-size: 0.8rem;
            color: #aaa;
        }

        .pwa-install-actions {
            display: flex;
            gap: 10px;
        }

        .pwa-install-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .pwa-install-btn.primary {
            background: linear-gradient(135deg, #42a5f5, #1e88e5);
            color: white;
        }

        .pwa-install-btn.primary:hover {
            transform: scale(1.05);
        }

        .pwa-install-btn.secondary {
            background: transparent;
            color: #888;
            padding: 10px;
        }

        .pwa-install-btn.secondary:hover {
            color: #fff;
        }

        /* Offline indicator */
        .offline-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(244, 67, 54, 0.9);
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 0.85rem;
            z-index: 1002;
            display: none;
        }

        .offline-indicator.show {
            display: block;
        }

        @media (max-width: 600px) {
            body {
                padding: 15px;
            }

            h1 {
                font-size: 1.5rem;
            }

            .input-section {
                padding: 20px 15px;
            }

            .input-group {
                flex-direction: column;
                align-items: stretch;
                gap: 16px;
            }

            .field {
                width: 100%;
            }

            input, select {
                width: 100%;
                font-size: 16px; /* Prevents iOS zoom on focus */
                min-width: unset;
            }

            .stats-row {
                flex-direction: column;
                gap: 10px;
            }

            .stat-badge {
                text-align: center;
            }

            .calendar-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .day-card {
                padding: 12px;
            }

            .day-percentage {
                font-size: 1.5rem;
            }

            .main-recommendation {
                font-size: 2rem;
            }

            .recommendation-card {
                padding: 20px 15px;
            }

            .buffer-info {
                flex-direction: column;
                text-align: center;
            }

            .by-midnight-info {
                flex-direction: column;
                text-align: center;
                gap: 5px;
            }

            .usage-comparison {
                grid-template-columns: 1fr;
            }

            .whatif-impact {
                grid-template-columns: 1fr;
            }

            .feature-input-group {
                flex-direction: column;
                align-items: flex-start;
            }

            .feature-input-group input {
                width: 100%;
            }

            .feature-card {
                padding: 20px 15px;
            }

            .cooldown-display {
                gap: 4px;
            }

            .countdown-unit {
                padding: 10px 8px;
                min-width: 55px;
            }

            .countdown-value {
                font-size: 1.4rem;
            }

            .countdown-separator {
                font-size: 1.2rem;
                margin-bottom: 15px;
            }

            .cooldown-explanation {
                font-size: 0.8rem;
            }

            .sleep-input-row {
                flex-direction: column;
                gap: 10px;
            }

            .sleep-toggle-row {
                flex-wrap: wrap;
            }

            .extended-usage-value {
                font-size: 2rem;
            }

            .pwa-install-banner {
                flex-direction: column;
                padding: 15px;
                padding-bottom: calc(15px + env(safe-area-inset-bottom));
            }

            .pwa-install-content {
                width: 100%;
            }

            .pwa-install-actions {
                width: 100%;
                justify-content: space-between;
            }

            .pwa-install-btn {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Claude logo rain background -->
    <div class="bg-pattern" id="bgPattern"></div>
    
    <div class="container">
        <h1>Claude Weekly Usage Planner</h1>
        <p class="subtitle">Plan your Claude usage to last the entire week</p>

        <div class="input-section">
            <div class="input-group">
                <div class="field">
                    <label for="resetDay">Weekly Reset Day</label>
                    <select id="resetDay">
                        <option value="0">Sunday</option>
                        <option value="1">Monday</option>
                        <option value="2">Tuesday</option>
                        <option value="3">Wednesday</option>
                        <option value="4" selected>Thursday</option>
                        <option value="5">Friday</option>
                        <option value="6">Saturday</option>
                    </select>
                </div>
                <div class="field">
                    <label for="resetTime">Reset Time</label>
                    <input type="time" id="resetTime" value="15:30">
                </div>
                <div class="field">
                    <label for="dailyLimit">Daily Limit (%)</label>
                    <input type="number" id="dailyLimit" min="1" max="20" value="13.5" step="0.5" placeholder="e.g., 13.5">
                </div>
            </div>
        </div>

        <div class="results-section" id="results">
            <div class="recommendation-card">
                <h2>Today's Recommendation</h2>
                <div class="main-recommendation" id="todayLimit">--</div>
                <p class="recommendation-detail" id="recommendationText">
                    Enter your reset time and current usage to get your personalized recommendation.
                </p>
                <div class="stats-row">
                    <div class="stat-badge">Time until reset: <span id="timeUntilReset">--</span></div>
                    <div class="stat-badge">Days remaining: <span id="daysRemaining">--</span></div>
                    <div class="stat-badge">Safety buffer: <span id="availableBudget">--</span></div>
                </div>

                <div class="current-usage-section">
                    <div class="usage-input-row">
                        <span class="remaining-today" id="remainingToday">You can use up to --% more today</span>
                    </div>
                    <div class="by-midnight-info">
                        <span class="midnight-label">By midnight tonight:</span>
                        <span class="midnight-value" id="midnightValue">--%</span>
                    </div>
                </div>

                <div class="buffer-info">
                    <p id="bufferText">A safety buffer is reserved to ensure you have emergency capacity in the final hours before reset.</p>
                </div>
            </div>

            <div class="calendar-section">
                <h2>Weekly Usage Plan</h2>
                <div class="calendar-grid" id="calendarGrid">
                    <!-- Calendar cards will be inserted here -->
                </div>
                <p class="last-updated" id="lastUpdated">Last updated: --</p>
            </div>
        </div>

        <!-- Additional Features Section -->
        <div class="additional-features">
            <h2>üìä Advanced Tools</h2>

            <!-- Current Usage Tracking -->
            <div class="feature-card">
                <h3><span class="icon">üìç</span> Current Usage Tracker</h3>
                <p style="color: #888; margin-bottom: 15px; font-size: 0.9rem;">
                    Enter your actual current usage from Claude's settings to see if you're on track.
                </p>
                <div class="feature-input-group">
                    <label for="actualUsage">My current usage:</label>
                    <input type="number" id="actualUsage" min="0" max="100" step="1" placeholder="e.g., 33">
                    <span class="unit">%</span>
                </div>

                <!-- Sleep Compensation Toggle -->
                <div class="sleep-compensation-section">
                    <div class="sleep-toggle-row">
                        <label class="toggle-switch">
                            <input type="checkbox" id="sleepCompensationToggle">
                            <span class="toggle-slider"></span>
                        </label>
                        <div class="sleep-toggle-label">
                            <span class="sleep-toggle-title">üò¥ Sleep Compensation</span>
                            <span class="sleep-toggle-desc">Borrow usage from your sleep hours</span>
                        </div>
                    </div>
                    
                    <div class="sleep-inputs" id="sleepInputs">
                        <div class="sleep-input-row">
                            <div class="sleep-field">
                                <label for="bedtime">Bedtime</label>
                                <input type="time" id="bedtime" value="23:00">
                            </div>
                            <div class="sleep-field">
                                <label for="waketime">Wake time</label>
                                <input type="time" id="waketime" value="07:00">
                            </div>
                        </div>
                        <p class="sleep-info" id="sleepInfo">
                            Sleep duration: <strong id="sleepDuration">8 hours</strong> 
                            = <strong id="sleepBonus">+4.5%</strong> bonus
                        </p>
                    </div>
                </div>

                <div class="tracking-results" id="trackingResults">
                    <div class="usage-comparison" id="usageComparison">
                        <div class="comparison-item">
                            <div class="label">Planned Limit (Now)</div>
                            <div class="value planned" id="plannedNow">--%</div>
                        </div>
                        <div class="comparison-item">
                            <div class="label">Actual Usage</div>
                            <div class="value actual" id="actualNow">--%</div>
                        </div>
                    </div>

                    <!-- Extended Usage Card (shown when sleep compensation is on) -->
                    <div class="extended-usage-card" id="extendedUsageCard">
                        <div class="extended-usage-header">
                            <span class="extended-icon">üåô</span>
                            <span class="extended-title">Extended Limit till Bedtime</span>
                        </div>
                        <div class="extended-usage-value" id="extendedUsageValue">--%</div>
                        <p class="extended-usage-breakdown" id="extendedBreakdown">
                            -- till bedtime + -- sleep bonus = --
                        </p>
                        <p class="extended-usage-note">
                            Use up to this amount before bed to stay on track when you wake up
                        </p>
                    </div>

                    <div class="progress-container">
                        <div class="progress-bar-bg">
                            <div class="progress-bar-planned" id="progressPlanned"></div>
                            <div class="progress-bar-actual" id="progressActual"></div>
                        </div>
                        <div class="progress-labels">
                            <span>0%</span>
                            <span>Planned limit</span>
                            <span>100%</span>
                        </div>
                    </div>

                    <div class="status-indicator" id="statusIndicator">
                        <span class="icon" id="statusIcon">‚úì</span>
                        <span class="text" id="statusText">You're on track!</span>
                    </div>

                    <div class="remaining-budget" id="remainingBudget">
                        You can still use <strong>--</strong> more right now.
                    </div>

                    <!-- Cooldown Timer (shown when over budget) -->
                    <div class="cooldown-timer" id="cooldownTimer">
                        <div class="cooldown-header">
                            <span class="cooldown-icon">‚è≥</span>
                            <span class="cooldown-title">Cooldown Required</span>
                        </div>
                        <p class="cooldown-explanation" id="cooldownExplanation">
                            You've used more than your planned budget. Wait for your allowance to catch up.
                        </p>
                        <div class="cooldown-display">
                            <div class="countdown-unit">
                                <span class="countdown-value" id="cooldownDays">0</span>
                                <span class="countdown-label">days</span>
                            </div>
                            <div class="countdown-separator">:</div>
                            <div class="countdown-unit">
                                <span class="countdown-value" id="cooldownHours">0</span>
                                <span class="countdown-label">hours</span>
                            </div>
                            <div class="countdown-separator">:</div>
                            <div class="countdown-unit">
                                <span class="countdown-value" id="cooldownMinutes">0</span>
                                <span class="countdown-label">min</span>
                            </div>
                            <div class="countdown-separator">:</div>
                            <div class="countdown-unit">
                                <span class="countdown-value" id="cooldownSeconds">0</span>
                                <span class="countdown-label">sec</span>
                            </div>
                        </div>
                        <p class="cooldown-resume" id="cooldownResume">
                            You can resume at: <strong id="resumeTime">--</strong>
                        </p>
                    </div>
                </div>
            </div>

            <!-- What-If Calculator -->
            <div class="feature-card">
                <h3><span class="icon">üîÆ</span> "What If" Scenario Calculator</h3>
                <p style="color: #888; margin-bottom: 15px; font-size: 0.9rem;">
                    See how using extra today affects your daily budget for the rest of the week.
                </p>
                <div class="feature-input-group">
                    <label for="extraUsage">If I use extra today:</label>
                    <input type="number" id="extraUsage" min="0" max="100" step="1" placeholder="e.g., 10">
                    <span class="unit">%</span>
                </div>

                <div class="whatif-results" id="whatifResults">
                    <div class="whatif-impact">
                        <div class="impact-item">
                            <div class="label">Current Daily Budget</div>
                            <div class="value current" id="currentDailyBudget">--%</div>
                        </div>
                        <div class="impact-item">
                            <div class="label">New Daily Budget</div>
                            <div class="value new" id="newDailyBudget">--%</div>
                        </div>
                        <div class="impact-item">
                            <div class="label">Total After Extra</div>
                            <div class="value" id="totalAfterExtra">--%</div>
                        </div>
                        <div class="impact-item">
                            <div class="label">Days Remaining</div>
                            <div class="value" id="daysRemainingWhatif">--</div>
                        </div>
                    </div>

                    <div id="whatifMessage"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings saved toast -->
    <div class="settings-saved-toast" id="savedToast">‚úì Settings saved</div>

    <!-- Offline indicator -->
    <div class="offline-indicator" id="offlineIndicator">üì¥ You're offline - app still works!</div>

    <!-- PWA Install Banner -->
    <div class="pwa-install-banner" id="installBanner">
        <div class="pwa-install-content">
            <span class="pwa-install-icon">ü§ñ</span>
            <div class="pwa-install-text">
                <h4>Install Claude Planner</h4>
                <p>Add to home screen for quick access</p>
            </div>
        </div>
        <div class="pwa-install-actions">
            <button class="pwa-install-btn secondary" id="installDismiss">Not now</button>
            <button class="pwa-install-btn primary" id="installBtn">Install</button>
        </div>
    </div>

    <script>
        const DAYS = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const FULL_DAYS = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

        // Global variables for tracking/whatif features
        let globalCumulativeLimit = 0;
        let globalDailyLimit = 13.5;
        let globalHoursRemaining = 0;
        let globalDaysRemaining = 0;
        let globalNextReset = null;

        function calculate() {
            const resetDay = parseInt(document.getElementById('resetDay').value);
            const resetTime = document.getElementById('resetTime').value;
            const dailyLimit = parseFloat(document.getElementById('dailyLimit').value) || 13.5;

            const now = new Date();
            const [resetHour, resetMinute] = resetTime.split(':').map(Number);

            // Calculate LAST reset date (when the current week started)
            let lastReset = new Date(now);
            lastReset.setHours(resetHour, resetMinute, 0, 0);

            // Find the most recent occurrence of reset day
            let daysSinceReset = (now.getDay() - resetDay + 7) % 7;
            
            // If it's the same day, check if reset time has passed
            if (daysSinceReset === 0) {
                const resetTimeToday = new Date(now);
                resetTimeToday.setHours(resetHour, resetMinute, 0, 0);
                if (now < resetTimeToday) {
                    // Reset hasn't happened yet today, so last reset was 7 days ago
                    daysSinceReset = 7;
                }
            }

            lastReset.setDate(now.getDate() - daysSinceReset);

            // Calculate next reset
            let nextReset = new Date(lastReset);
            nextReset.setDate(lastReset.getDate() + 7);

            // Calculate hours since last reset
            const msElapsed = now - lastReset;
            const hoursElapsed = msElapsed / (1000 * 60 * 60);

            // Calculate hourly rate based on daily limit
            const hourlyRate = dailyLimit / 24;

            // Calculate cumulative limit for right now
            const cumulativeLimit = Math.floor(hoursElapsed * hourlyRate);

            // Calculate cumulative limit by midnight tonight
            let midnight = new Date(now);
            midnight.setDate(midnight.getDate() + 1);
            midnight.setHours(0, 0, 0, 0);
            
            // Cap midnight at next reset if reset comes before midnight
            if (midnight > nextReset) {
                midnight = nextReset;
            }
            
            const hoursToMidnight = (midnight - lastReset) / (1000 * 60 * 60);
            const midnightLimit = Math.floor(hoursToMidnight * hourlyRate);

            // Calculate time remaining until next reset
            const msRemaining = nextReset - now;
            const hoursRemaining = msRemaining / (1000 * 60 * 60);
            const daysRemaining = hoursRemaining / 24;

            // Calculate safety buffer
            const fullCapacityPerDay = 100 / 7;
            const dailySavings = fullCapacityPerDay - dailyLimit;
            const totalSafetyBuffer = dailySavings * 7;

            // Update UI
            document.getElementById('results').classList.add('visible');
            document.getElementById('todayLimit').textContent = `Up to ${cumulativeLimit}% now`;
            
            const hoursLeft = Math.floor(hoursRemaining);
            const minutesLeft = Math.floor((hoursRemaining - hoursLeft) * 60);
            document.getElementById('timeUntilReset').textContent = `${hoursLeft}h ${minutesLeft}m`;
            document.getElementById('daysRemaining').textContent = daysRemaining.toFixed(1);
            document.getElementById('availableBudget').textContent = `${totalSafetyBuffer.toFixed(1)}%`;

            document.getElementById('remainingToday').textContent = 
                `Hourly rate: ~${hourlyRate.toFixed(2)}% per hour (${dailyLimit}% per day)`;

            document.getElementById('midnightValue').textContent = `${midnightLimit}%`;

            document.getElementById('recommendationText').textContent = 
                `${hoursElapsed.toFixed(1)} hours have passed since the last reset (${FULL_DAYS[resetDay]} ${formatTime(resetHour, resetMinute)}). ` +
                `At ${dailyLimit}% per day, you can use up to ${cumulativeLimit}% right now.`;

            document.getElementById('bufferText').textContent = 
                `By using ${dailyLimit}% daily instead of ${fullCapacityPerDay.toFixed(1)}%, you'll have ${totalSafetyBuffer.toFixed(1)}% safety buffer by the end of the week.`;

            // Generate calendar
            generateCalendar(lastReset, nextReset, dailyLimit, hourlyRate);

            // Update last updated timestamp
            const updateTime = new Date();
            document.getElementById('lastUpdated').textContent = 
                `Last updated: ${updateTime.toLocaleTimeString()} (auto-updates every 30 min)`;

            // Store values globally for tracking/whatif features
            globalCumulativeLimit = cumulativeLimit;
            globalDailyLimit = dailyLimit;
            globalHoursRemaining = hoursRemaining;
            globalDaysRemaining = daysRemaining;
            globalHourlyRate = hourlyRate;
            globalLastReset = lastReset;
            globalNextReset = nextReset;

            // Update tracking, extended usage, and what-if displays if functions exist
            if (typeof calculateExtendedUsage === 'function') calculateExtendedUsage();
            if (typeof updateTracking === 'function') updateTracking();
            if (typeof updateWhatIf === 'function') updateWhatIf();
        }

        function formatTime(hour, minute) {
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const h = hour % 12 || 12;
            const m = minute.toString().padStart(2, '0');
            return `${h}:${m} ${ampm}`;
        }

        function generateCalendar(lastReset, nextReset, dailyLimit, hourlyRate) {
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';

            const now = new Date();
            
            // Start from the day of last reset
            let currentDate = new Date(lastReset);
            currentDate.setHours(0, 0, 0, 0);

            // If reset was in the afternoon, the first calendar day is the reset day itself
            // We want to show from reset day to the day before next reset
            
            let dayIndex = 0;

            while (dayIndex < 8) {
                const card = document.createElement('div');
                card.className = 'day-card';

                const isToday = currentDate.toDateString() === now.toDateString();
                const isPast = currentDate < new Date(now.getFullYear(), now.getMonth(), now.getDate());
                
                if (isToday) {
                    card.classList.add('today');
                } else if (isPast) {
                    card.classList.add('past');
                }

                const dayName = DAYS[currentDate.getDay()];
                const dayDate = currentDate.getDate();
                const month = currentDate.toLocaleString('default', { month: 'short' });

                // Calculate cumulative limit at end of this day (midnight)
                let endOfDay = new Date(currentDate);
                endOfDay.setDate(endOfDay.getDate() + 1); // Next day midnight
                endOfDay.setHours(0, 0, 0, 0);

                // But cap it at next reset time
                if (endOfDay > nextReset) {
                    endOfDay = nextReset;
                }

                // Hours from last reset to end of this day
                const hoursFromReset = (endOfDay - lastReset) / (1000 * 60 * 60);
                const cumulativeAtEndOfDay = Math.floor(hoursFromReset * hourlyRate);

                // For display, cap at 100% (which would include safety buffer usage)
                const displayPercentage = Math.min(cumulativeAtEndOfDay, 100);

                // Add color class based on percentage
                let levelClass = 'level-safe';
                if (displayPercentage >= 90) {
                    levelClass = 'level-danger';
                } else if (displayPercentage >= 70) {
                    levelClass = 'level-warning';
                } else if (displayPercentage >= 40) {
                    levelClass = 'level-moderate';
                }
                card.classList.add(levelClass);

                // Set fill percentage as CSS variable
                card.style.setProperty('--fill-percent', `${displayPercentage}%`);

                let label = 'cumulative';
                if (isToday) {
                    label = 'by midnight';
                }

                // Check if this is the reset day
                if (currentDate.getDay() === lastReset.getDay() && 
                    currentDate.toDateString() === lastReset.toDateString()) {
                    label = 'reset day';
                }

                card.innerHTML = `
                    <div class="day-name">${dayName}</div>
                    <div class="day-date">${month} ${dayDate}</div>
                    <div class="day-percentage">${displayPercentage}%</div>
                    <div class="day-label">${label}</div>
                `;

                calendarGrid.appendChild(card);

                currentDate.setDate(currentDate.getDate() + 1);
                dayIndex++;

                // Stop if we've passed the next reset
                if (currentDate > nextReset) break;
            }
        }

        // Auto-calculate on page load
        document.addEventListener('DOMContentLoaded', function() {
            calculate();
            // Update every 30 minutes (1800000 ms)
            setInterval(calculate, 1800000);
        });

        // Recalculate when tab becomes visible (handles sleep/wake scenarios)
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                calculate();
            }
        });

        // Also handle window focus for additional coverage
        window.addEventListener('focus', function() {
            calculate();
        });

        // Recalculate when inputs change
        document.getElementById('resetDay').addEventListener('change', calculate);
        document.getElementById('resetTime').addEventListener('change', calculate);
        document.getElementById('dailyLimit').addEventListener('input', calculate);

        // Generate falling Claude logo background
        function generateBackground() {
            const container = document.getElementById('bgPattern');
            
            // Number of snowflakes based on screen width
            const numFlakes = Math.floor(window.innerWidth / 60);
            
            let html = '';
            for (let i = 0; i < numFlakes; i++) {
                // Random horizontal position across full width
                const x = Math.random() * 100;
                
                // Random size (smaller = further away, falls slower)
                const sizeClass = (i % 5) + 1;
                const size = 20 + Math.random() * 35;
                
                // Random opacity for depth
                const opacity = 0.02 + Math.random() * 0.04;
                
                // Random animation type (1, 2, or 3 for different sway patterns)
                const animType = (i % 3) + 1;
                
                // Random start delay so they don't all start at the same position
                const delay = Math.random() * -45;
                
                html += `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" 
                    class="snowflake snow-speed-${sizeClass} snow-anim-${animType}"
                    style="left:${x}%; width:${size}px; height:${size}px; opacity:${opacity}; animation-delay:${delay}s;">
                    <g transform="translate(50,50)">
                        ${Array.from({length: 14}, (_, j) => `<polygon points="0,-8 4,-45 0,-42 -4,-45" transform="rotate(${j * 360/14})" />`).join('')}
                        <circle r="12" />
                    </g>
                </svg>`;
            }
            container.innerHTML = html;
        }

        // Generate background on load
        generateBackground();
        
        // Regenerate on resize (debounced)
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(generateBackground, 200);
        });

        // ==========================================
        // LOCAL STORAGE - Persistent Settings
        // ==========================================
        
        const STORAGE_KEYS = {
            resetDay: 'claude_planner_resetDay',
            resetTime: 'claude_planner_resetTime',
            dailyLimit: 'claude_planner_dailyLimit',
            actualUsage: 'claude_planner_actualUsage',
            sleepCompensation: 'claude_planner_sleepCompensation',
            bedtime: 'claude_planner_bedtime',
            waketime: 'claude_planner_waketime'
        };

        function saveSettings() {
            localStorage.setItem(STORAGE_KEYS.resetDay, document.getElementById('resetDay').value);
            localStorage.setItem(STORAGE_KEYS.resetTime, document.getElementById('resetTime').value);
            localStorage.setItem(STORAGE_KEYS.dailyLimit, document.getElementById('dailyLimit').value);
            
            // Show toast notification
            showSavedToast();
        }

        function saveSleepSettings() {
            localStorage.setItem(STORAGE_KEYS.sleepCompensation, document.getElementById('sleepCompensationToggle').checked);
            localStorage.setItem(STORAGE_KEYS.bedtime, document.getElementById('bedtime').value);
            localStorage.setItem(STORAGE_KEYS.waketime, document.getElementById('waketime').value);
        }

        function loadSettings() {
            const savedResetDay = localStorage.getItem(STORAGE_KEYS.resetDay);
            const savedResetTime = localStorage.getItem(STORAGE_KEYS.resetTime);
            const savedDailyLimit = localStorage.getItem(STORAGE_KEYS.dailyLimit);
            const savedActualUsage = localStorage.getItem(STORAGE_KEYS.actualUsage);
            const savedSleepCompensation = localStorage.getItem(STORAGE_KEYS.sleepCompensation);
            const savedBedtime = localStorage.getItem(STORAGE_KEYS.bedtime);
            const savedWaketime = localStorage.getItem(STORAGE_KEYS.waketime);

            if (savedResetDay !== null) {
                document.getElementById('resetDay').value = savedResetDay;
            }
            if (savedResetTime !== null) {
                document.getElementById('resetTime').value = savedResetTime;
            }
            if (savedDailyLimit !== null) {
                document.getElementById('dailyLimit').value = savedDailyLimit;
            }
            if (savedActualUsage !== null) {
                document.getElementById('actualUsage').value = savedActualUsage;
            }
            if (savedSleepCompensation === 'true') {
                document.getElementById('sleepCompensationToggle').checked = true;
                document.getElementById('sleepInputs').classList.add('show');
            }
            if (savedBedtime !== null) {
                document.getElementById('bedtime').value = savedBedtime;
            }
            if (savedWaketime !== null) {
                document.getElementById('waketime').value = savedWaketime;
            }
        }

        function showSavedToast() {
            const toast = document.getElementById('savedToast');
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        // Save settings when inputs change (debounced)
        let saveTimeout;
        function debouncedSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveSettings, 500);
        }

        // Add save listeners to main settings
        document.getElementById('resetDay').addEventListener('change', debouncedSave);
        document.getElementById('resetTime').addEventListener('change', debouncedSave);
        document.getElementById('dailyLimit').addEventListener('input', debouncedSave);

        // ==========================================
        // CURRENT USAGE TRACKING
        // ==========================================

        // Cooldown timer variables
        let cooldownInterval = null;
        let cooldownEndTime = null;
        let globalHourlyRate = 0;
        let globalLastReset = null;

        function updateTracking() {
            const actualUsageInput = document.getElementById('actualUsage').value;
            const trackingResults = document.getElementById('trackingResults');
            const cooldownTimer = document.getElementById('cooldownTimer');
            
            if (!actualUsageInput || actualUsageInput === '') {
                trackingResults.classList.remove('visible');
                cooldownTimer.classList.remove('show');
                stopCooldownTimer();
                return;
            }

            // Parse and cap at 100% (usage can never exceed 100%)
            const rawUsage = parseFloat(actualUsageInput);
            const actualUsage = Math.min(rawUsage, 100);
            const wasCapped = rawUsage > 100;
            
            trackingResults.classList.add('visible');

            // Save to localStorage (save the capped value)
            localStorage.setItem(STORAGE_KEYS.actualUsage, actualUsage.toString());

            // Update comparison values
            document.getElementById('plannedNow').textContent = globalCumulativeLimit + '%';
            document.getElementById('actualNow').textContent = actualUsage + '%' + (wasCapped ? ' (max)' : '');

            // Update progress bars
            const plannedBar = document.getElementById('progressPlanned');
            const actualBar = document.getElementById('progressActual');
            
            plannedBar.style.width = Math.min(globalCumulativeLimit, 100) + '%';
            actualBar.style.width = Math.min(actualUsage, 100) + '%';

            // Update progress bar color based on status
            actualBar.classList.remove('over-budget', 'way-over');
            if (actualUsage > globalCumulativeLimit * 1.2) {
                actualBar.classList.add('way-over');
            } else if (actualUsage > globalCumulativeLimit) {
                actualBar.classList.add('over-budget');
            }

            // Calculate difference and status
            const difference = globalCumulativeLimit - actualUsage;
            const statusIndicator = document.getElementById('statusIndicator');
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');
            const remainingBudget = document.getElementById('remainingBudget');

            statusIndicator.className = 'status-indicator';

            if (difference >= 10) {
                // Well ahead
                statusIndicator.classList.add('ahead');
                statusIcon.textContent = 'üéâ';
                statusText.textContent = `Great! You're ${Math.floor(difference)}% ahead of schedule.`;
            } else if (difference >= 0) {
                // On track
                statusIndicator.classList.add('on-track');
                statusIcon.textContent = '‚úì';
                statusText.textContent = difference > 0 
                    ? `You're on track, ${Math.floor(difference)}% under your planned limit.`
                    : `You're exactly on your planned limit.`;
            } else if (difference >= -10) {
                // Slightly behind
                statusIndicator.classList.add('behind');
                statusIcon.textContent = '‚ö†Ô∏è';
                statusText.textContent = `You're ${Math.floor(Math.abs(difference))}% over your planned limit. Consider slowing down.`;
            } else {
                // Way over
                statusIndicator.classList.add('over');
                statusIcon.textContent = 'üö®';
                statusText.textContent = `Warning! You're ${Math.floor(Math.abs(difference))}% over your planned limit!`;
            }

            // Update remaining budget message
            if (difference > 0) {
                remainingBudget.innerHTML = `You can still use <strong>${Math.floor(difference)}%</strong> more right now while staying on track.`;
                cooldownTimer.classList.remove('show');
                stopCooldownTimer();
            } else {
                remainingBudget.innerHTML = `You've used <strong>${Math.floor(Math.abs(difference))}%</strong> more than planned. Try to reduce usage.`;
                
                // Calculate and show cooldown timer
                /*
                 * COOLDOWN FORMULA:
                 * ==================
                 * hourlyRate = dailyLimit / 24 (percentage per hour)
                 * hoursNeeded = actualUsage / hourlyRate (hours from reset to reach actualUsage at prescribed rate)
                 * hoursElapsed = time since last reset in hours
                 * cooldownHours = hoursNeeded - hoursElapsed (hours to wait)
                 * 
                 * Example: dailyLimit=13.5%, actualUsage=60%, hoursElapsed=90
                 * hourlyRate = 13.5/24 = 0.5625% per hour
                 * hoursNeeded = 60/0.5625 = 106.67 hours from reset
                 * cooldownHours = 106.67 - 90 = 16.67 hours to wait
                 */
                if (globalHourlyRate > 0) {
                    const hoursNeeded = actualUsage / globalHourlyRate;
                    const now = new Date();
                    const hoursElapsed = globalLastReset ? (now - globalLastReset) / (1000 * 60 * 60) : 0;
                    const cooldownHours = hoursNeeded - hoursElapsed;
                    
                    if (cooldownHours > 0) {
                        // Calculate the exact time when user can resume
                        cooldownEndTime = new Date(now.getTime() + cooldownHours * 60 * 60 * 1000);
                        
                        // Update the explanation with the formula
                        document.getElementById('cooldownExplanation').innerHTML = 
                            `At your rate of <strong>${globalHourlyRate.toFixed(3)}%/hour</strong>, ` +
                            `it takes <strong>${hoursNeeded.toFixed(1)} hours</strong> from reset to reach ${actualUsage}%. ` +
                            `You're at ${hoursElapsed.toFixed(1)} hours, so wait <strong>${cooldownHours.toFixed(1)} hours</strong>.`;
                        
                        // Format resume time
                        document.getElementById('resumeTime').textContent = cooldownEndTime.toLocaleString([], {
                            weekday: 'short',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        cooldownTimer.classList.add('show');
                        startCooldownTimer();
                    } else {
                        cooldownTimer.classList.remove('show');
                        stopCooldownTimer();
                    }
                }
            }
        }

        function startCooldownTimer() {
            // Clear any existing interval
            stopCooldownTimer();
            
            // Update immediately
            updateCooldownDisplay();
            
            // Update every second
            cooldownInterval = setInterval(updateCooldownDisplay, 1000);
        }

        function stopCooldownTimer() {
            if (cooldownInterval) {
                clearInterval(cooldownInterval);
                cooldownInterval = null;
            }
        }

        function updateCooldownDisplay() {
            if (!cooldownEndTime) return;
            
            const now = new Date();
            const diff = cooldownEndTime - now;
            
            if (diff <= 0) {
                // Cooldown complete
                document.getElementById('cooldownDays').textContent = '0';
                document.getElementById('cooldownHours').textContent = '0';
                document.getElementById('cooldownMinutes').textContent = '0';
                document.getElementById('cooldownSeconds').textContent = '0';
                stopCooldownTimer();
                
                // Recalculate tracking to update status
                updateTracking();
                return;
            }
            
            // Calculate days, hours, minutes, seconds
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            // Update display with leading zeros
            document.getElementById('cooldownDays').textContent = days;
            document.getElementById('cooldownHours').textContent = hours.toString().padStart(2, '0');
            document.getElementById('cooldownMinutes').textContent = minutes.toString().padStart(2, '0');
            document.getElementById('cooldownSeconds').textContent = seconds.toString().padStart(2, '0');
        }

        // ==========================================
        // WHAT-IF SCENARIO CALCULATOR
        // ==========================================

        function updateWhatIf() {
            const extraUsageInput = document.getElementById('extraUsage').value;
            const whatifResults = document.getElementById('whatifResults');
            
            if (!extraUsageInput || extraUsageInput === '') {
                whatifResults.classList.remove('visible');
                return;
            }

            const extraUsage = parseFloat(extraUsageInput);
            whatifResults.classList.add('visible');

            // Get actual usage if available, otherwise use planned (cap at 100%)
            const actualUsageInput = document.getElementById('actualUsage').value;
            const currentUsage = actualUsageInput ? Math.min(parseFloat(actualUsageInput), 100) : globalCumulativeLimit;

            // Calculate new totals (cap at 100%)
            const totalAfterExtra = Math.min(currentUsage + extraUsage, 100);
            
            // Calculate remaining capacity after extra usage
            const fullCapacity = 100;
            const safetyBuffer = (100 / 7 - globalDailyLimit) * 7;
            const usableCapacity = fullCapacity - safetyBuffer;
            const remainingCapacity = usableCapacity - totalAfterExtra;
            
            // Calculate new daily budget for remaining days
            const daysLeft = globalDaysRemaining;
            const newDailyBudget = daysLeft > 0 ? remainingCapacity / daysLeft : 0;

            // Update display
            document.getElementById('currentDailyBudget').textContent = globalDailyLimit.toFixed(1) + '%';
            document.getElementById('newDailyBudget').textContent = newDailyBudget.toFixed(1) + '%';
            document.getElementById('totalAfterExtra').textContent = Math.round(totalAfterExtra) + '%';
            document.getElementById('daysRemainingWhatif').textContent = daysLeft.toFixed(1);

            // Update new daily budget styling
            const newBudgetEl = document.getElementById('newDailyBudget');
            newBudgetEl.classList.remove('warning');
            if (newDailyBudget < globalDailyLimit * 0.7) {
                newBudgetEl.classList.add('warning');
            }

            // Show appropriate message
            const messageEl = document.getElementById('whatifMessage');
            if (newDailyBudget <= 0) {
                messageEl.innerHTML = `
                    <div class="whatif-warning">
                        <span>üö®</span>
                        <span>This would exceed your weekly capacity! You'd have no budget left for the remaining ${daysLeft.toFixed(1)} days.</span>
                    </div>
                `;
            } else if (newDailyBudget < globalDailyLimit * 0.5) {
                messageEl.innerHTML = `
                    <div class="whatif-warning">
                        <span>‚ö†Ô∏è</span>
                        <span>This would significantly reduce your daily budget from ${globalDailyLimit}% to just ${newDailyBudget.toFixed(1)}% for the next ${daysLeft.toFixed(1)} days.</span>
                    </div>
                `;
            } else if (newDailyBudget < globalDailyLimit) {
                messageEl.innerHTML = `
                    <div class="whatif-ok" style="background: rgba(255, 193, 7, 0.15); border-color: rgba(255, 193, 7, 0.3); color: #ffd54f;">
                        <span>üìä</span>
                        <span>Manageable. Your daily budget would reduce from ${globalDailyLimit}% to ${newDailyBudget.toFixed(1)}% for the remaining days.</span>
                    </div>
                `;
            } else {
                messageEl.innerHTML = `
                    <div class="whatif-ok">
                        <span>‚úì</span>
                        <span>No problem! You'd still have ${newDailyBudget.toFixed(1)}% per day, which is ${(newDailyBudget - globalDailyLimit).toFixed(1)}% more than your current rate.</span>
                    </div>
                `;
            }
        }

        // Event listeners for tracking and what-if inputs
        document.getElementById('actualUsage').addEventListener('input', function() {
            updateTracking();
            updateWhatIf(); // Re-calculate what-if when actual usage changes
            
            // Auto-correct input if over 100
            const input = document.getElementById('actualUsage');
            if (parseFloat(input.value) > 100) {
                input.style.borderColor = 'rgba(255, 193, 7, 0.5)';
                input.title = 'Value capped at 100%';
            } else {
                input.style.borderColor = '';
                input.title = '';
            }
        });

        document.getElementById('extraUsage').addEventListener('input', updateWhatIf);

        // ==========================================
        // SLEEP COMPENSATION
        // ==========================================

        function calculateSleepDuration() {
            const bedtime = document.getElementById('bedtime').value;
            const waketime = document.getElementById('waketime').value;
            
            if (!bedtime || !waketime) return 0;

            const [bedHour, bedMin] = bedtime.split(':').map(Number);
            const [wakeHour, wakeMin] = waketime.split(':').map(Number);

            // Convert to minutes from midnight
            let bedMinutes = bedHour * 60 + bedMin;
            let wakeMinutes = wakeHour * 60 + wakeMin;

            // If wake time is before bed time, it's the next day
            if (wakeMinutes <= bedMinutes) {
                wakeMinutes += 24 * 60; // Add 24 hours
            }

            const sleepMinutes = wakeMinutes - bedMinutes;
            return sleepMinutes / 60; // Return hours
        }

        function calculateExtendedUsage() {
            const sleepCompensationEnabled = document.getElementById('sleepCompensationToggle').checked;
            const extendedUsageCard = document.getElementById('extendedUsageCard');
            
            if (!sleepCompensationEnabled) {
                extendedUsageCard.classList.remove('show');
                return null;
            }

            const bedtime = document.getElementById('bedtime').value;
            const waketime = document.getElementById('waketime').value;
            
            if (!bedtime || !waketime || !globalLastReset || !globalNextReset) {
                extendedUsageCard.classList.remove('show');
                return null;
            }

            const [bedHour, bedMin] = bedtime.split(':').map(Number);
            const [wakeHour, wakeMin] = waketime.split(':').map(Number);
            const now = new Date();
            
            // Create bedtime date for today
            let bedtimeDate = new Date(now);
            bedtimeDate.setHours(bedHour, bedMin, 0, 0);
            
            // If bedtime has already passed today, use tomorrow's bedtime
            if (bedtimeDate <= now) {
                bedtimeDate.setDate(bedtimeDate.getDate() + 1);
            }

            // Create wake time date (after bedtime)
            let waketimeDate = new Date(bedtimeDate);
            waketimeDate.setHours(wakeHour, wakeMin, 0, 0);
            
            // If wake time appears to be before bed time, it's the next day
            if (waketimeDate <= bedtimeDate) {
                waketimeDate.setDate(waketimeDate.getDate() + 1);
            }

            const sleepHours = (waketimeDate - bedtimeDate) / (1000 * 60 * 60);

            /*
             * RESET BOUNDARY LOGIC:
             * =====================
             * Check if the weekly reset happens between NOW and wake time.
             * 
             * Timeline possibilities:
             *   NOW -----> BEDTIME -----> WAKE
             *   
             * Case A: Reset happens between NOW and BEDTIME
             *   - User can use up to 100% before reset (it all gets wiped)
             *   - After reset, new week starts
             *   - Sleep bonus calculated from new week's rate
             *   
             * Case B: Reset happens between BEDTIME and WAKE (during sleep)
             *   - User uses current week quota until bed
             *   - Reset happens while sleeping
             *   - Wakes up in new week with some hours already elapsed
             *   
             * Case C: Reset happens AFTER wake time (normal case)
             *   - Standard calculation applies
             *   - extendedUsage = plannedAtBedtime + sleepBonus
             *   
             * Key insight: We need to check where reset falls in the timeline:
             *   NOW -> RESET -> BEDTIME -> WAKE  (Case A: reset before bed)
             *   NOW -> BEDTIME -> RESET -> WAKE  (Case B: reset during sleep)  
             *   NOW -> BEDTIME -> WAKE -> RESET  (Case C: normal, no reset interference)
             */

            const resetBeforeBedtime = globalNextReset <= bedtimeDate && globalNextReset > now;
            const resetDuringSleep = globalNextReset > bedtimeDate && globalNextReset < waketimeDate;
            const resetAfterWake = globalNextReset >= waketimeDate;

            let extendedUsage, plannedAtBedtime, sleepBonus, breakdownText;

            if (resetBeforeBedtime) {
                // CASE A: Reset happens between NOW and BEDTIME!
                // User can burn through remaining quota - it resets before bed anyway
                // Then calculate sleep bonus based on hours from reset to wake
                
                const hoursFromResetToWake = (waketimeDate - globalNextReset) / (1000 * 60 * 60);
                const usageAccruedAfterReset = hoursFromResetToWake * globalHourlyRate;
                
                // User can use up to 100% before reset since it wipes anyway
                extendedUsage = 100;
                
                breakdownText = `<strong>‚ö†Ô∏è Reset at ${formatTimeFromDate(globalNextReset)} before bedtime!</strong><br>` +
                    `Use up to <strong>100%</strong> ‚Äì it resets before you sleep.<br>` +
                    `You'll wake at ~<strong>${usageAccruedAfterReset.toFixed(1)}%</strong> in the new week.`;
                
                document.getElementById('sleepDuration').textContent = sleepHours.toFixed(1) + ' hours';
                document.getElementById('sleepBonus').textContent = 'üîÑ Reset before bed!';
                
            } else if (resetDuringSleep) {
                // CASE B: Reset happens DURING sleep (between bedtime and wake)
                // User uses current week quota until bed
                // Wakes up in new week
                
                const hoursToBedtime = (bedtimeDate - globalLastReset) / (1000 * 60 * 60);
                plannedAtBedtime = Math.floor(hoursToBedtime * globalHourlyRate);
                
                // Hours from reset to wake = usage accrued while sleeping in new week
                const hoursFromResetToWake = (waketimeDate - globalNextReset) / (1000 * 60 * 60);
                const usageAccruedAfterReset = hoursFromResetToWake * globalHourlyRate;
                
                // User can use up to 100% before bed since it resets during sleep
                extendedUsage = 100;
                
                breakdownText = `<strong>‚ö†Ô∏è Reset at ${formatTimeFromDate(globalNextReset)} during sleep!</strong><br>` +
                    `Use up to <strong>100%</strong> ‚Äì it resets while you sleep.<br>` +
                    `You'll wake at ~<strong>${usageAccruedAfterReset.toFixed(1)}%</strong> in the new week.`;
                
                document.getElementById('sleepDuration').textContent = sleepHours.toFixed(1) + ' hours';
                document.getElementById('sleepBonus').textContent = 'üîÑ Reset during sleep!';
                
            } else {
                // CASE C: Normal case - reset is after wake time (or already passed)
                // Standard sleep compensation calculation
                
                const hoursToBedtime = (bedtimeDate - globalLastReset) / (1000 * 60 * 60);
                plannedAtBedtime = Math.floor(hoursToBedtime * globalHourlyRate);
                sleepBonus = sleepHours * globalHourlyRate;
                extendedUsage = Math.floor(plannedAtBedtime + sleepBonus);
                
                // Cap at 100%
                extendedUsage = Math.min(extendedUsage, 100);
                
                breakdownText = `<strong>${plannedAtBedtime}%</strong> till bedtime + <strong>${sleepBonus.toFixed(1)}%</strong> sleep bonus = <strong>${extendedUsage}%</strong>`;
                
                document.getElementById('sleepDuration').textContent = sleepHours.toFixed(1) + ' hours';
                document.getElementById('sleepBonus').textContent = '+' + sleepBonus.toFixed(1) + '%';
            }

            // Update the UI
            extendedUsageCard.classList.add('show');
            document.getElementById('extendedUsageValue').textContent = extendedUsage + '%';
            document.getElementById('extendedBreakdown').innerHTML = breakdownText;

            return extendedUsage;
        }

        // Helper function to format time from Date object
        function formatTimeFromDate(date) {
            const hours = date.getHours();
            const minutes = date.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const h = hours % 12 || 12;
            const m = minutes.toString().padStart(2, '0');
            return `${h}:${m} ${ampm}`;
        }

        // Sleep compensation toggle
        document.getElementById('sleepCompensationToggle').addEventListener('change', function() {
            const sleepInputs = document.getElementById('sleepInputs');
            if (this.checked) {
                sleepInputs.classList.add('show');
            } else {
                sleepInputs.classList.remove('show');
            }
            saveSleepSettings();
            calculateExtendedUsage();
            updateTracking();
        });

        // Sleep time inputs
        document.getElementById('bedtime').addEventListener('change', function() {
            saveSleepSettings();
            calculateExtendedUsage();
            updateTracking();
        });

        document.getElementById('waketime').addEventListener('change', function() {
            saveSleepSettings();
            calculateExtendedUsage();
            updateTracking();
        });

        // ==========================================
        // INITIALIZATION
        // ==========================================

        // Load saved settings on page load
        loadSettings();

        // Calculate extended usage after settings are loaded
        setTimeout(() => {
            calculateExtendedUsage();
            updateTracking();
        }, 100);

        // ==========================================
        // PWA SUPPORT
        // ==========================================

        // Create and register Web App Manifest
        const manifest = {
            name: 'Claude Weekly Usage Planner',
            short_name: 'Claude Planner',
            description: 'Plan your Claude AI usage to last the entire week with smart budgeting',
            start_url: window.location.href.split('?')[0],
            display: 'standalone',
            background_color: '#1a1a2e',
            theme_color: '#1a1a2e',
            orientation: 'portrait-primary',
            icons: [
                {
                    src: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><rect fill="%231a1a2e" width="512" height="512" rx="100"/><text y="380" x="256" text-anchor="middle" font-size="350">ü§ñ</text></svg>',
                    sizes: '512x512',
                    type: 'image/svg+xml',
                    purpose: 'any maskable'
                },
                {
                    src: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 192"><rect fill="%231a1a2e" width="192" height="192" rx="40"/><text y="145" x="96" text-anchor="middle" font-size="130">ü§ñ</text></svg>',
                    sizes: '192x192',
                    type: 'image/svg+xml',
                    purpose: 'any maskable'
                }
            ]
        };

        // Register manifest
        const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(manifestBlob);
        const manifestLink = document.createElement('link');
        manifestLink.rel = 'manifest';
        manifestLink.href = manifestURL;
        document.head.appendChild(manifestLink);

        // Note: Service Workers require a separate .js file served over HTTPS
        // For full offline support, place sw.js in the same directory as this HTML file
        
        // Try to register service worker if sw.js exists
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').then((registration) => {
                console.log('‚úì Service Worker registered - full offline support enabled');
            }).catch((error) => {
                // sw.js not found or not served over HTTPS - that's okay
                console.log('‚Ñπ Service Worker not available - app still works, data saved locally');
            });
        }
        // For now, the app is installable and data persists via localStorage

        // PWA Install Prompt handling
        let deferredPrompt;
        const installBanner = document.getElementById('installBanner');
        const installBtn = document.getElementById('installBtn');
        const installDismiss = document.getElementById('installDismiss');

        // Check if already installed or dismissed
        const isInstalled = window.matchMedia('(display-mode: standalone)').matches || 
                           window.navigator.standalone === true;
        const isDismissed = localStorage.getItem('pwa_install_dismissed');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install banner if not dismissed recently
            if (!isInstalled && !isDismissed) {
                setTimeout(() => {
                    installBanner.classList.add('show');
                }, 2000); // Show after 2 seconds
            }
        });

        installBtn.addEventListener('click', async () => {
            if (!deferredPrompt) return;
            
            installBanner.classList.remove('show');
            deferredPrompt.prompt();
            
            const { outcome } = await deferredPrompt.userChoice;
            console.log('Install prompt outcome:', outcome);
            deferredPrompt = null;
        });

        installDismiss.addEventListener('click', () => {
            installBanner.classList.remove('show');
            // Remember dismissal for 7 days
            localStorage.setItem('pwa_install_dismissed', Date.now().toString());
        });

        // Handle successful installation
        window.addEventListener('appinstalled', () => {
            console.log('App installed successfully');
            installBanner.classList.remove('show');
            deferredPrompt = null;
        });

        // Offline/Online indicators
        const offlineIndicator = document.getElementById('offlineIndicator');

        function updateOnlineStatus() {
            if (!navigator.onLine) {
                offlineIndicator.classList.add('show');
            } else {
                offlineIndicator.classList.remove('show');
            }
        }

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus(); // Check initial status

        // Log PWA status
        if (isInstalled) {
            console.log('App is running in standalone mode (installed)');
        }
    </script>
</body>
</html>
